<!DOCTYPE html>
<html><head lang="en">
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>浅析jmp_buf的定义 - Ekstasis&#39;s Blog</title><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="description" content="" />
	<meta property="og:image" content=""/>
	<meta property="og:url" content="https://rzyn2020.github.io/posts/%E6%B5%85%E6%9E%90jump-buf%E7%9A%84%E5%AE%9A%E4%B9%89/">
  <meta property="og:site_name" content="Ekstasis&#39;s Blog">
  <meta property="og:title" content="浅析jmp_buf的定义">
  <meta property="og:locale" content="en">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2021-11-14T09:23:52+00:00">
    <meta property="article:modified_time" content="2021-11-14T09:23:52+00:00">
    <meta property="article:tag" content="C">
    <meta property="article:tag" content="Knowledge">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="浅析jmp_buf的定义">

        <link href="https://rzyn2020.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css" rel="stylesheet">
	

	
	<link rel="stylesheet" type="text/css" media="screen" href="https://rzyn2020.github.io/css/main.df3f44613463554998dacba673a067eb0777f76fe3d12bc0a1de5bad493ef666.css" />
		<link id="darkModeStyle" rel="stylesheet" type="text/css" href="https://rzyn2020.github.io/css/dark.50b57e12d401420df23965fed157368aba37b76df0ecefd0b1ecd4da664f01a0.css" media="(prefers-color-scheme: dark)"  />
  	
   	 	<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath: [['$', '$']]                  
    },
    loader:{
      load: ['ui/safe']
    },
  };
</script>
  	

	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="https://rzyn2020.github.io/">Ekstasis&#39;s Blog</a>
	</div>
	<nav>
		
		<a href="/posts/">All Posts</a>
		
		<a href="/categories/">Categories</a>
		
		<a href="/tags/">Tags</a>
		
		<a href="https://rzyn2020.github.io/algorithm/">Algorithm</a>
		
		
	</nav>
</header>

<main>
  <article>
    <div class="post-container">
      
      <div class="post-content">
        <div class="title">
          <h1 class="title">浅析jmp_buf的定义</h1>
          <div class="meta">Posted on Nov 14, 2021</div>
        </div>
        
        <section class="body">
          <p><code>int setjmp(jmp_buf env)</code></p>
<p><code>void longjmp(jmp_buf env, int val)</code></p>
<p>setjmp 和 longjmp 是<code>setjmp.h</code>定义的相互协作的一组跳转函数。 调用 setjmp 时可以将当前的环境保存在一个<code>jmp_buf</code>类型的变量中，之后调用 longjmp 后会跳转到 setjmp 执行后的下一条语句执行，就好像刚刚从 setjmp返回一样。</p>
<blockquote>
<p>函数行为描述见man，源码见<a href="https://www.gnu.org/software/libc/">glibc</a>。</p></blockquote>
<p>其中,<code>jmp_buf</code>的定义如下:</p>
<div class="highlight"><pre tabindex="0" style="color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#c678dd">typedef</span> <span style="color:#e5c07b">long</span> <span style="color:#e5c07b">int</span> <span style="color:#e06c75">__jmp_buf</span>[<span style="color:#d19a66">8</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#7f848e">/* Calling environment, plus possibly a saved signal mask.  */</span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">struct</span> <span style="color:#e06c75">__jmp_buf_tag</span>
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    <span style="color:#7f848e">/* NOTE: The machine-dependent definitions of `__sigsetjmp&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">       assume that a `jmp_buf&#39; begins with a `__jmp_buf&#39; and that
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">       `__mask_was_saved&#39; follows it.  Do not move these members
</span></span></span><span style="display:flex;"><span><span style="color:#7f848e">       or add others before it.  */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">__jmp_buf</span> <span style="color:#e06c75">__jmpbuf</span>;		<span style="color:#7f848e">/* Calling environment.  */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e5c07b">int</span> <span style="color:#e06c75">__mask_was_saved</span>;	<span style="color:#7f848e">/* Saved the signal mask?  */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#e06c75">__sigset_t</span> <span style="color:#e06c75">__saved_mask</span>;	<span style="color:#7f848e">/* Saved signal mask.  */</span>
</span></span><span style="display:flex;"><span>  };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c678dd">typedef</span> <span style="color:#c678dd">struct</span> <span style="color:#e06c75">__jmp_buf_tag</span> <span style="color:#e06c75">jmp_buf</span>[<span style="color:#d19a66">1</span>];
</span></span></code></pre></div><p>本来预想jmp_buf应该是简单的一个存储寄存器信息的数组，却发现其定义较为复杂。在阅读其定义的时候，又牵扯出了许多不熟悉的c知识点。试解析定义如下：
其中<code>typedef struct __jmp_buf_tag jmp_buf[1]</code>定义了一个名为<code>jmp_buf</code>的变量类型,它实际上是一个大小为1的<code>struct __jmp_buf_tag</code>数组。而结构体<code>struct __jmp_buf_tag</code>包含三个成员，后两个与信号机制有关，不做讨论。第一个成员为<code>__jmp_buf</code>类型，用来保存寄存器信息。而<code>__jmp_buf</code>类型实际上是一个大小为8的<code>long int</code>数组。
那么为什么要把实际上存储信息的结构体<code>__jmp_buf_tag</code>包含在一个数组里面呢？也许是因为将数组当作参数传递时总是传递数组的地址，而将结构体当作参数传递时却总是将整个结构体的值赋值一遍传给被调用函数。我们的<code>jmp_buf</code>作为一个在函数调用间保存信息的实体应该满足数组的特征，因此将其定义为数组更合适一些。当然，如果不这样做，每次被调用函数需要结构体<code>__jmp_buf_tag</code>时传入它的指针也是可行的，只是略显麻烦罢了。</p>
<blockquote>
<p>hint:
结构体定义了一种变量类型，作为一个整体复制和赋值。在行为上更加类似于int而非int[];
变量名是与值绑定的符号，而指针是与一个地址值绑定的符号。</p></blockquote>
        </section>
        <div class="post-tags">
          
          
          <nav class="nav tags">
            <ul class="tags">
              
              <li><a href="/tags/c">C</a></li>
              
              <li><a href="/tags/knowledge">Knowledge</a></li>
              
            </ul>
          </nav>
          
          
        </div>
      </div>

      
      
      <div class="toc">
        <strong>Table of contents:</strong>
        <nav id="TableOfContents"></nav>
      </div>
      
    </div>

    </article>
</main>
<footer>
  <div style="display:flex"><a class="soc" href="https://github.com/RZYN2020" rel="me" title="Github"><svg class="feather">
   <use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#%25!s%28%3cnil%3e%29" />
</svg></a><a class="border"></a><a class="soc" href="mailto:zhaoyzzz@outlook.com" rel="me" title="Email"><svg class="feather">
   <use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#%25!s%28%3cnil%3e%29" />
</svg></a><a class="border"></a><a class="soc" href="https://rzyn2020.github.io/resume/resume.html" rel="me" title="Resume"><svg class="feather">
   <use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#%25!s%28%3cnil%3e%29" />
</svg></a><a class="border"></a><a class="soc" href="https://neodb.social/users/Ekstasis" rel="me" title="Neodb"><svg class="feather">
   <use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#%25!s%28%3cnil%3e%29" />
</svg></a><a class="border"></a><a class="soc" href="https://myanimelist.net/animelist/yuki960" rel="me" title="Mal"><svg class="feather">
   <use href="/svg/feather-sprite.51cf5647cb1987f769b616558f2620fd9423d72058490231b391bf6aa3744b55.svg#%25!s%28%3cnil%3e%29" />
</svg></a><a class="border"></a></div>
  <div class="footer-info">
    2025  <a
      href="https://github.com/athul/archie">Archie Theme</a> | Built with <a href="https://gohugo.io">Hugo</a>
  </div>
</footer>



</div>
    </body>
</html>
